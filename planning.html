<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f6f7f9; margin:0; padding:16px; }
    h1 { margin-bottom:8px; }

    .card {
      background:#fff;
      padding:12px;
      margin-bottom:12px;
      border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);
    }

    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    button {
      padding:6px 10px;
      cursor:pointer;
    }

    select, input {
      padding:6px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      font-size:12px;
    }

    th, td {
      border:1px solid #ddd;
      padding:4px;
      text-align:center;
      vertical-align:middle;
    }

    th.roleCol {
      position:sticky;
      left:0;
      background:#fafafa;
      z-index:2;
      min-width:120px;
      text-align:left;
    }

    td.roleCol {
      position:sticky;
      left:0;
      background:#fff;
      text-align:left;
      font-weight:bold;
      z-index:1;
    }

    .muted { color:#666; font-size:12px; }
    .log { font-size:12px; margin-top:8px; }
  </style>
</head>

<body>

<h1>Planning machine</h1>

<div class="card toolbar">
  <label>Machine :
    <select id="activity">
      <option value="ME1">ME1</option>
      <option value="ME2">ME2</option>
      <option value="VP">VP</option>
    </select>
  </label>

  <label>Début :
    <input type="date" id="start">
  </label>

  <button id="prevWeek">◀ Semaine -1</button>
  <button id="today">Aujourd’hui</button>
  <button id="nextWeek">Semaine +1 ▶</button>

  <button id="btnLoad">Charger</button>
</div>

<div class="card">
  <b>Campagne active :</b>
  <span id="campaignInfo" class="muted">(non chargée)</span>
</div>

<div class="card">
  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="log" id="log"></div>

<script>
/* =====================
   CONFIG SUPABASE
===================== */
const SUPABASE_URL = "https://hgishjwhpvfxsmvtjgbf.supabase.co";
const SUPABASE_ANON_KEY = "TON_ANON_KEY_ICI"; // <-- garde la tienne

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const DAYS = 14;

/* =====================
   UTILITAIRES DATES
===================== */
function startOfWeekMonday(d){
  const x = new Date(d);
  const day = x.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
}

function addDays(d,n){
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
}

function iso(d){
  return d.toISOString().slice(0,10);
}

const fmtDay = new Intl.DateTimeFormat("fr-FR",{weekday:"short"});
const fmtDate = new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit"});

function labelDay(d){
  const w = fmtDay.format(d).replace(".","");
  return w.charAt(0).toUpperCase()+w.slice(1)+" "+fmtDate.format(d);
}

/* =====================
   DOM HELPERS
===================== */
function el(id){ return document.getElementById(id); }
function log(t){ el("log").textContent = t; }

/* =====================
   AUTH / PROFIL
===================== */
async function loadProfile(){
  const { data:{user} } = await supabase.auth.getUser();
  if(!user) return null;

  const { data } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("user_id", user.id)
    .maybeSingle();

  return data;
}

/* =====================
   CAMPAGNE
===================== */
async function loadCampaign(machine, refDate){
  if(machine === "VP"){
    return {
      machine:"VP",
      mode:"VP",
      label:"Activité VP (hors campagnes)"
    };
  }

  const { data, error } = await supabase
    .from("campaigns")
    .select("*")
    .eq("machine", machine)
    .lte("start_date", iso(refDate))
    .gte("end_date", iso(refDate))
    .limit(1)
    .maybeSingle();

  if(error) throw new Error(error.message);
  if(!data) throw new Error("Aucune campagne active");

  let mode = (data.at_phase === "MAINTENANCE")
    ? "AT_HIR"
    : data.cnpe_mode;

  return {
    ...data,
    mode,
    label:`Campagne ${data.site} – ${machine} – ${mode} – phase ${data.at_phase}`
  };
}

/* =====================
   POSTES PAR MODE
===================== */
function baseRowsFor(machine, mode){
  if(machine === "VP"){
    return ["PCEO","AIP","AIZ","CPP","CPZ","CC","ACC","AT"];
  }

  if(mode === "AT_HIR"){
    return ["CC/ACC","CPP","CPZ","AT"];
  }

  if(mode === "2x8"){
    return [
      "CC","ACC","AT",
      "CPP AM","CPP PM",
      "CPZ AM","CPZ PM",
      "AIZ AM","AIZ PM",
      "AIP AM","AIP PM"
    ];
  }

  return ["CC","ACC","AT","CPP","CPZ","AIZ","AIP"];
}

/* =====================
   ASSIGNMENTS
===================== */
async function loadAssignments(activity, start, end){
  const { data, error } = await supabase
    .from("assignments")
    .select("date, role, employee:employees(first_name,last_name)")
    .eq("activity", activity)
    .gte("date", iso(start))
    .lte("date", iso(end));

  if(error) throw new Error(error.message);

  const map = {};
  for(const a of data){
    const k = a.role+"|"+a.date;
    const name = a.employee
      ? a.employee.first_name+" "+a.employee.last_name.charAt(0)+"."
      : "?";
    map[k] = name;
  }
  return map;
}

/* =====================
   RENDER
===================== */
function renderHeader(start, days){
  const tr = document.createElement("tr");
  const th0 = document.createElement("th");
  th0.className="roleCol";
  th0.textContent="Poste";
  tr.appendChild(th0);

  for(let i=0;i<days;i++){
    const th = document.createElement("th");
    th.textContent = labelDay(addDays(start,i));
    tr.appendChild(th);
  }
  el("thead").innerHTML="";
  el("thead").appendChild(tr);
}

function renderBody(rows, start, days, map){
  el("tbody").innerHTML="";
  for(const r of rows){
    const tr = document.createElement("tr");
    const td0 = document.createElement("td");
    td0.className="roleCol";
    td0.textContent=r;
    tr.appendChild(td0);

    for(let i=0;i<days;i++){
      const d = iso(addDays(start,i));
      const td = document.createElement("td");
      td.textContent = map[r+"|"+d] || "";
      tr.appendChild(td);
    }
    el("tbody").appendChild(tr);
  }
}

/* =====================
   NAVIGATION
===================== */
let currentStart = startOfWeekMonday(new Date());

function syncStart(){
  el("start").value = iso(currentStart);
}

el("prevWeek").onclick = () => {
  currentStart = addDays(currentStart,-7);
  syncStart();
};
el("nextWeek").onclick = () => {
  currentStart = addDays(currentStart,7);
  syncStart();
};
el("today").onclick = () => {
  currentStart = startOfWeekMonday(new Date());
  syncStart();
};

syncStart();

/* =====================
   CHARGER
===================== */
el("btnLoad").onclick = async () => {
  try{
    log("Chargement...");
    const profile = await loadProfile();
    if(!profile){ log("❌ non connecté"); return; }

    const activity = el("activity").value;
    currentStart = startOfWeekMonday(new Date(el("start").value+"T00:00:00"));
    syncStart();

    const start = new Date(currentStart);
    const end = addDays(start, DAYS-1);

    const campaign = await loadCampaign(activity, start);
    el("campaignInfo").textContent = campaign.label;

    const rows = baseRowsFor(activity, campaign.mode);
    const map = await loadAssignments(activity, start, end);

    renderHeader(start, DAYS);
    renderBody(rows, start, DAYS, map);

    log("✅ Planning chargé");
  }catch(e){
    console.error(e);
    log("❌ "+e.message);
    el("campaignInfo").textContent="Erreur";
  }
};
</script>

</body>
</html>
