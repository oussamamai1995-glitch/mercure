<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Planning Mercure — Machine</title>
  <style>
    body{font-family:system-ui;margin:16px;background:#0b1020;color:#e8eeff}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .card{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:14px;margin:12px 0;background:rgba(255,255,255,.04)}
    input,button,select{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.05);color:#e8eeff}
    button{cursor:pointer}
    .muted{color:#a9b4d6;font-size:13px}
    .ok{color:#2ee59d}
    .bad{color:#ff6b6b}
    .grid{overflow:auto;border:1px solid rgba(255,255,255,.10);border-radius:14px}
    table{border-collapse:collapse;min-width:980px;width:100%}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;vertical-align:top}
    th{position:sticky;top:0;background:#0b1020;z-index:2}
    .roleCol{width:190px;position:sticky;left:0;background:#0b1020;z-index:1;border-right:1px solid rgba(255,255,255,.10)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);margin:2px 4px 2px 0;font-size:12px}
    .st-VALIDE{background:rgba(46,229,157,.12)}
    .st-SOUMIS{background:rgba(138,180,255,.12)}
    .st-BROUILLON{background:rgba(255,255,255,.08)}
    .st-REFUSE{background:rgba(255,107,107,.12)}
    .pf{border-style:dashed}
    a{color:#8ab4ff;text-decoration:none}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);overflow:auto}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="top">
    <h2 style="margin:0">Planning machine</h2>
    <a href="./index.html">← accueil</a>
    <span id="who" class="muted"></span>
  </div>

  <div class="card">
    <div class="bar">
      <label class="muted">Machine</label>
      <select id="activity">
        <option value="ME1">ME1</option>
        <option value="ME2">ME2</option>
        <option value="VP">VP</option>
      </select>

      <label class="muted">Semaine (lundi)</label>
      <input id="start" type="date"/>

      <button id="prevWeek">◀ Semaine -1</button>
      <button id="today">Aujourd’hui</button>
      <button id="nextWeek">Semaine +1 ▶</button>

      <button id="btnLoad">Charger</button>
      <button id="btnLogout">Logout</button>
    </div>

    <div class="muted" style="margin-top:8px">
      Vue fixe : <b>2 semaines</b>. Entête : <b>jour + date</b> en format FR.
    </div>
  </div>

  <div class="card">
    <h3>Console</h3>
    <pre id="out">(logs)</pre>
  </div>

  <div class="card">
    <h3>Planning (postes)</h3>
    <div class="grid">
      <table>
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://hgishjwhpvfxsmvtjgbf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnaXNoandocHZmeHNtdnRqZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MzA5NTYsImV4cCI6MjA4NTIwNjk1Nn0.3BZiQRWivik3h8S9CyHIff3e2F7M0Oudw5rP7dN5-Zw";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id) => document.getElementById(id);
  const log = (x) => el("out").textContent = (typeof x === "string") ? x : JSON.stringify(x, null, 2);

  // ===== Dates utils =====
  function iso(d){ return d.toISOString().slice(0,10); }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
  function startOfWeekMonday(d){
    const x = new Date(d);
    const day = x.getDay(); // 0=dim
    const diff = (day === 0 ? -6 : 1 - day);
    x.setDate(x.getDate()+diff);
    x.setHours(0,0,0,0);
    return x;
  }
  const fmtDay = new Intl.DateTimeFormat("fr-FR", { weekday:"short" });
  const fmtDate = new Intl.DateTimeFormat("fr-FR", { day:"2-digit", month:"2-digit", year:"2-digit" });
  function labelDay(d){
    const w = fmtDay.format(d).replace(".", "");
    const dd = fmtDate.format(d);
    return w.charAt(0).toUpperCase() + w.slice(1) + " " + dd;
  }

  // ===== Auth/profile =====
  async function getSession(){
    const { data, error } = await supabase.auth.getSession();
    if(error) throw error;
    return data.session || null;
  }
  async function loadProfile(){
    const s = await getSession();
    if(!s){
      el("who").innerHTML = `<span class="bad">pas de session</span>`;
      return null;
    }
    const { data, error } = await supabase
      .from("user_profiles")
      .select("role, display_name")
      .eq("user_id", s.user.id)
      .maybeSingle();
    if(error){ log("Erreur user_profiles: " + error.message); return null; }
    el("who").innerHTML = `Connecté: <span class="ok">${data?.display_name || s.user.email}</span> — rôle: <b>${data?.role || "?"}</b>`;
    return data;
  }

  // ===== Planning rows (postes) =====
  function baseRowsFor(activity, mode){
    const base7 = [
      { label:"CC", role:"CC", shift:"JOUR" },
      { label:"ACC", role:"ACC", shift:"JOUR" },
      { label:"AT", role:"AT", shift:"JOUR" },
      { label:"CPP", role:"CPP", shift:"JOUR" },
      { label:"CPZ", role:"CPZ", shift:"JOUR" },
      { label:"AIZ", role:"AIZ", shift:"JOUR" },
      { label:"AIP", role:"AIP", shift:"JOUR" },
    ];
    if(activity === "VP"){
      return [{ label:"PCEO", role:"PCEO", shift:"JOUR" }, ...base7];
    }
    if(mode === "2x8"){
      return [
        { label:"CC", role:"CC", shift:"JOUR" },
        { label:"ACC", role:"ACC", shift:"JOUR" },
        { label:"AT", role:"AT", shift:"JOUR" },
        { label:"CPP AM", role:"CPP", shift:"AM" },
        { label:"CPP PM", role:"CPP", shift:"PM" },
        { label:"CPZ AM", role:"CPZ", shift:"AM" },
        { label:"CPZ PM", role:"CPZ", shift:"PM" },
        { label:"AIZ AM", role:"AIZ", shift:"AM" },
        { label:"AIZ PM", role:"AIZ", shift:"PM" },
        { label:"AIP AM", role:"AIP", shift:"AM" },
        { label:"AIP PM", role:"AIP", shift:"PM" },
      ];
    }
    if(mode === "AT_HIR"){
      return [
        { label:"CC/ACC", role:"CC", shift:"JOUR" },
        { label:"CPP", role:"CPP", shift:"JOUR" },
        { label:"CPZ", role:"CPZ", shift:"JOUR" },
        { label:"AT", role:"AT", shift:"JOUR" },
      ];
    }
    return base7; // 1x8 / 1x10
  }

  function initials(first, last){
    const fi = (first||"").trim().slice(0,1).toUpperCase();
    const li = (last||"").trim().slice(0,1).toUpperCase();
    const fn = (first||"").trim();
    return (fn && li) ? `${fn} ${li}.` : (first || last || "");
  }
  function pill(txt, status, is_pf){
    const span = document.createElement("span");
    span.className = `pill st-${status || "BROUILLON"} ${is_pf ? "pf" : ""}`;
    span.textContent = txt;
    return span;
  }

  function renderHeader(startDate, days){
    const thead = el("thead");
    const tr = document.createElement("tr");
    const th0 = document.createElement("th");
    th0.className = "roleCol";
    th0.textContent = "Poste";
    tr.appendChild(th0);
    for(let i=0;i<days;i++){
      const d = addDays(startDate, i);
      const th = document.createElement("th");
      th.textContent = labelDay(d);
      tr.appendChild(th);
    }
    thead.innerHTML = "";
    thead.appendChild(tr);
  }

  async function loadAssignments(activity, startDate, endDate){
    const { data: asg, error: e1 } = await supabase
      .from("assignments")
      .select("employee_id, activity, assign_date, role, shift, is_pf, status")
      .eq("activity", activity)
      .gte("assign_date", iso(startDate))
      .lte("assign_date", iso(endDate));

    if(e1) throw e1;

    const ids = [...new Set((asg||[]).map(x => x.employee_id).filter(Boolean))];
    const empMap = new Map();
    if(ids.length){
      const { data: emps, error: e2 } = await supabase
        .from("employees")
        .select("id, first_name, last_name")
        .in("id", ids);
      if(e2) throw e2;
      for(const e of emps) empMap.set(e.id, e);
    }

    const map = new Map();
    for(const a of (asg||[])){
      const d = (a.assign_date||"").slice(0,10);
      const key = `${d}|${a.role}|${a.shift}`;
      const emp = empMap.get(a.employee_id) || {};
      const item = { ...a, first_name: emp.first_name, last_name: emp.last_name };
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(item);
    }
    return map;
  }

  function renderBody(rows, startDate, days, map){
    const tbody = el("tbody");
    tbody.innerHTML = "";
    for(const r of rows){
      const tr = document.createElement("tr");

      const tdRole = document.createElement("td");
      tdRole.className = "roleCol";
      tdRole.innerHTML = `<b>${r.label}</b><div class="muted">${r.role} • ${r.shift}</div>`;
      tr.appendChild(tdRole);

      for(let i=0;i<days;i++){
        const d = iso(addDays(startDate, i));
        const key = `${d}|${r.role}|${r.shift}`;
        const td = document.createElement("td");

        const items = map.get(key) || [];
        if(!items.length){
          td.innerHTML = `<span class="muted">—</span>`;
        }else{
          for(const it of items){
            td.appendChild(pill(initials(it.first_name, it.last_name), it.status, it.is_pf));
          }
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  // ===== Mode auto (MVP) =====
  // Pour l’instant, on garde un mode par défaut:
  // - VP => VP rows
  // - ME1/ME2 => 1x8
  // Tu pourras le brancher à ta table "campaigns" ensuite.
  function inferMode(activity){
    if(activity === "VP") return "1x8";
    return "1x8"; // à remplacer par lookup campaigns
  }

  // ===== Navigation 2 semaines =====
  const DAYS = 14;
  let currentStart = startOfWeekMonday(new Date());
  function syncStartInput(){ el("start").value = iso(currentStart); }

  el("prevWeek").onclick = () => { currentStart = addDays(currentStart, -7); syncStartInput(); };
  el("nextWeek").onclick = () => { currentStart = addDays(currentStart, 7); syncStartInput(); };
  el("today").onclick = () => { currentStart = startOfWeekMonday(new Date()); syncStartInput(); };

  el("btnLoad").onclick = async () => {
    try{
      log("Chargement...");
      const profile = await loadProfile();
      if(!profile){ log("❌ pas de session: retourne à l’accueil et connecte-toi."); return; }

      const activity = el("activity").value;
      currentStart = startOfWeekMonday(new Date(el("start").value + "T00:00:00"));
      syncStartInput();

      const startDate = new Date(currentStart);
      const endDate = addDays(startDate, DAYS - 1);

      renderHeader(startDate, DAYS);

      const mode = inferMode(activity);
      const rows = baseRowsFor(activity, mode);

      const map = await loadAssignments(activity, startDate, endDate);
      renderBody(rows, startDate, DAYS, map);

      log("✅ OK");
    }catch(e){
      log("❌ " + (e?.message || e));
      console.error(e);
    }
  };

  el("btnLogout").onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = "./index.html";
  };

  // init
  syncStartInput();
  await loadProfile();
</script>
</body>
</html>
