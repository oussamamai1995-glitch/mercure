<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Planning Mercure — Login</title>
  <style>
    body{font-family:system-ui;margin:16px;background:#0b1020;color:#e8eeff}
    .card{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:14px;margin:12px 0;background:rgba(255,255,255,.04)}
    input,button,select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.05);color:#e8eeff;margin:6px 0}
    button{cursor:pointer}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.35);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .muted{color:#a9b4d6;font-size:13px}
    .ok{color:#2ee59d}
    .bad{color:#ff6b6b}
    a{color:#8ab4ff;text-decoration:none}
  </style>
</head>
<body>
  <h2>Planning Mercure — MVP</h2>

  <div class="card muted">
    Objectif: se connecter via Supabase, lire ton rôle (SALARIE/CHEF_CHANTIER/RESPONSABLE),
    puis accéder au planning (ME1/ME2/VP) directement via Supabase.
  </div>

  <div class="card">
    <h3>Connexion</h3>
    <input id="email" placeholder="Email" autocomplete="username">
    <input id="password" placeholder="Mot de passe" type="password" autocomplete="current-password">
    <div class="row">
      <button id="btnLogin">Se connecter</button>
      <button id="btnLogout">Se déconnecter</button>
    </div>
    <div id="status" class="muted">Statut : déconnecté</div>
    <pre id="sessionBox">Session : (vide)</pre>
  </div>

  <div class="card">
    <h3>Accès</h3>
    <div class="muted">Ton rôle Supabase (table <code>user_profiles</code>) :</div>
    <pre id="roleBox">(vide)</pre>

    <div class="row">
      <button id="goPlanning">Aller au planning</button>
      <button id="testEmployees">Test : lire employees</button>
    </div>

    <pre id="out">(résultats)</pre>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // === CONFIG ===
  const SUPABASE_URL = "https://hgishjwhpvfxsmvtjgbf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnaXNoandocHZmeHNtdnRqZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MzA5NTYsImV4cCI6MjA4NTIwNjk1Nn0.3BZiQRWivik3h8S9CyHIff3e2F7M0Oudw5rP7dN5-Zw";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = (id) => document.getElementById(id);
  const log = (msg) => el("out").textContent = typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);

  async function refreshSessionUI(){
    const { data, error } = await supabase.auth.getSession();
    if(error) throw error;
    const s = data.session;

    el("sessionBox").textContent = "Session : " + JSON.stringify(
      s ? { user_id: s.user.id, email: s.user.email, expires_at: s.expires_at } : null,
      null, 2
    );

    if(s){
      el("status").innerHTML = `Statut : <span class="ok">connecté</span> (${s.user.email})`;
    }else{
      el("status").innerHTML = `Statut : <span class="bad">déconnecté</span>`;
      el("roleBox").textContent = "(vide)";
    }
    return s;
  }

  async function loadRole(){
    const s = await refreshSessionUI();
    if(!s) return null;

    // On lit directement user_profiles (RLS doit autoriser le user à lire sa ligne)
    const { data, error } = await supabase
      .from("user_profiles")
      .select("user_id, role, employee_id, display_name, is_active")
      .eq("user_id", s.user.id)
      .maybeSingle();

    if(error){
      el("roleBox").textContent = "Erreur role: " + error.message;
      return null;
    }
    el("roleBox").textContent = JSON.stringify(data, null, 2);
    return data;
  }

  // Actions
  el("btnLogin").onclick = async () => {
    try{
      log("Connexion...");
      const email = el("email").value.trim();
      const password = el("password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      await loadRole();
      log("✅ Connecté + rôle chargé.");
    }catch(e){
      log("❌ " + (e?.message || e));
    }
  };

  el("btnLogout").onclick = async () => {
    await supabase.auth.signOut();
    await refreshSessionUI();
    log("Déconnecté");
  };

  el("goPlanning").onclick = async () => {
    const role = await loadRole();
    if(!role){ log("Connecte-toi d’abord."); return; }
    window.location.href = "./planning.html";
  };

  el("testEmployees").onclick = async () => {
    try{
      log("Lecture employees...");
      const role = await loadRole();
      if(!role){ log("Connecte-toi d’abord."); return; }

      // Lecture directe table employees (selon RLS)
      const { data, error } = await supabase
        .from("employees")
        .select("id, first_name, last_name, email, phone, is_active")
        .order("last_name", { ascending: true });

      if(error) throw error;
      log({ count: data.length, sample: data.slice(0, 5) });
    }catch(e){
      log("❌ " + (e?.message || e));
    }
  };

  // Auto load role if already logged in
  try{ await loadRole(); } catch(e){ log("❌ " + (e?.message || e)); }
</script>
</body>
</html>
